{% extends 'new_base.html.twig' %}

{% block title %}Elliteam - Je d√©pose ma candidature{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/candidates.css') }}">
{% endblock %}

{% block main %}
    <main>
        <a href="{{ path('app_home') }}" class="back-link">Retour √† l'accueil</a>

        <h2 class="page-title">Je d√©pose ma candidature</h2>
        <p class="page-subtitle">
            Partagez votre profil et vos envies avec nous. Nous sommes impatients de d√©couvrir votre talent !
        </p>

        {# Messages Flash de Symfony #}
        {% for message in app.flashes('success') %}
            <div class="success-message show" role="alert">
                <div class="success-icon">‚úì</div>
                <p>{{ message }}</p>
            </div>
        {% endfor %}

        {% for message in app.flashes('error') %}
            <div class="alert alert-danger" role="alert">
                {{ message }}
            </div>
        {% endfor %}

        {# Formulaire Symfony avec le design du fichier candidates.css #}
        <div class="form-container" id="formContainer">
            {{ form_start(form, {'attr': {'id': 'candidatureForm', 'novalidate': 'novalidate'}}) }}

            {# Nom et Pr√©nom #}
            <div class="form-group">
                <label for="{{ form.nomPrenom.vars.id }}" class="form-label">
                    Nom / Pr√©nom<span class="required">*</span>
                </label>
                {{ form_widget(form.nomPrenom, {
                    'attr': {
                        'class': 'form-input',
                        'placeholder': 'Votre nom et pr√©nom'
                    }
                }) }}
                {{ form_errors(form.nomPrenom) }}
            </div>

            {# Email et T√©l√©phone #}
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.email.vars.id }}" class="form-label">
                        Email<span class="required">*</span>
                    </label>
                    {{ form_widget(form.email, {
                        'attr': {
                            'class': 'form-input',
                            'placeholder': 'votre.email@exemple.com'
                        }
                    }) }}
                    {{ form_errors(form.email) }}
                </div>

                <div class="form-group">
                    <label for="{{ form.telephone.vars.id }}" class="form-label">
                        T√©l√©phone<span class="required">*</span>
                    </label>
                    {{ form_widget(form.telephone, {
                        'attr': {
                            'class': 'form-input',
                            'placeholder': '06 12 34 56 78'
                        }
                    }) }}
                    {{ form_errors(form.telephone) }}
                </div>
            </div>

            {# Poste recherch√© #}
            <div class="form-group">
                <label for="{{ form.posteRecherche.vars.id }}" class="form-label">
                    Poste recherch√©<span class="required">*</span>
                </label>
                {{ form_widget(form.posteRecherche, {
                    'attr': {
                        'class': 'form-input',
                        'placeholder': 'Ex: D√©veloppeur Web, Designer UI/UX, Chef de projet...'
                    }
                }) }}
                {{ form_errors(form.posteRecherche) }}
            </div>

            {# Pr√©tention salariale et Disponibilit√© #}
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.pretentionSalariale.vars.id }}" class="form-label">
                        Pr√©tention salariale<span class="required">*</span>
                    </label>
                    {{ form_widget(form.pretentionSalariale, {
                        'attr': {
                            'class': 'form-input',
                            'placeholder': 'Ex: 45K‚Ç¨, √Ä n√©gocier...'
                        }
                    }) }}
                    <p class="help-text">Indiquez votre fourchette ou "√Ä n√©gocier"</p>
                    {{ form_errors(form.pretentionSalariale) }}
                </div>

                <div class="form-group">
                    <label for="{{ form.disponibilite.vars.id }}" class="form-label">
                        Disponibilit√©<span class="required">*</span>
                    </label>
                    {{ form_widget(form.disponibilite, {
                        'attr': {
                            'class': 'form-select'
                        }
                    }) }}
                    {{ form_errors(form.disponibilite) }}
                </div>
            </div>

            {# CV Upload #}
            <div class="form-group">
                <label for="{{ form.cvFile.vars.id }}" class="form-label">
                    CV<span class="required">*</span>
                </label>
                <div class="file-input-wrapper">
                    <label for="{{ form.cvFile.vars.id }}" class="file-input-label required-file" id="cvLabel">
                        <span>üìÑ</span>
                        <span>Joindre votre CV (PDF uniquement, max 5 Mo) - Obligatoire</span>
                    </label>
                    {{ form_widget(form.cvFile, {
                        'attr': {
                            'class': 'file-input',
                            'accept': '.pdf'
                        }
                    }) }}
                </div>
                <div id="cvFileName" class="file-name"></div>
                {{ form_errors(form.cvFile) }}
            </div>

            {# Message optionnel #}
            <div class="form-group">
                <label for="{{ form.message.vars.id }}" class="form-label">
                    Message / Pr√©sentation rapide
                    <span class="optional">(optionnel)</span>
                </label>
                {{ form_widget(form.message, {
                    'attr': {
                        'class': 'form-textarea',
                        'placeholder': 'Parlez-nous de vous, de votre parcours, de vos motivations...'
                    }
                }) }}
                {{ form_errors(form.message) }}
            </div>

            {# Bouton de soumission #}
            {{ form_widget(form.submit, {
                'attr': {
                    'class': 'submit-btn'
                },
                'label': 'Envoyer ma candidature'
            }) }}

            {{ form_end(form) }}
        </div>

        {# Message de succ√®s (affich√© apr√®s redirection ou via JavaScript) #}
        <div id="successMessage" class="success-message">
            <div class="success-icon">‚úì</div>
            <p>Merci, votre candidature a bien √©t√© re√ßue.</p>
            <p style="font-size: 16px; margin-top: 10px; font-weight: 400;">
                Nous examinerons votre profil avec attention et reviendrons vers vous tr√®s prochainement.
            </p>
        </div>
    </main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('candidatureForm');
            const submitBtn = form.querySelector('.submit-btn');
            const cvFileInput = document.getElementById('{{ form.cvFile.vars.id }}');
            const cvLabel = document.getElementById('cvLabel');
            const cvFileName = document.getElementById('cvFileName');
            const formContainer = document.getElementById('formContainer');
            const successMessage = document.getElementById('successMessage');

            // Gestion de l'upload du fichier CV
            if (cvFileInput) {
                cvFileInput.addEventListener('change', function(e) {
                    const file = this.files[0];

                    if (file) {
                        // V√©rifier la taille (5Mo max)
                        const maxSize = 5 * 1024 * 1024; // 5MB
                        if (file.size > maxSize) {
                            alert('Le fichier est trop volumineux. Taille maximale : 5Mo');
                            this.value = '';
                            cvFileName.textContent = '';
                            cvLabel.classList.add('required-file');
                            return;
                        }

                        // V√©rifier le type (PDF uniquement)
                        if (file.type !== 'application/pdf') {
                            alert('Seuls les fichiers PDF sont accept√©s');
                            this.value = '';
                            cvFileName.textContent = '';
                            cvLabel.classList.add('required-file');
                            return;
                        }

                        // Afficher le nom du fichier
                        const fileSize = (file.size / 1024 / 1024).toFixed(2);
                        cvFileName.textContent = `‚úì ${file.name} (${fileSize} Mo)`;
                        cvFileName.classList.add('success');

                        // Changer le style du label
                        cvLabel.classList.remove('required-file');
                        cvLabel.style.borderColor = '#27ae60';
                        cvLabel.style.background = '#e8f5e9';
                        cvLabel.style.color = '#27ae60';
                    } else {
                        cvFileName.textContent = '';
                        cvFileName.classList.remove('success');
                        cvLabel.classList.add('required-file');
                        cvLabel.style.borderColor = '';
                        cvLabel.style.background = '';
                        cvLabel.style.color = '';
                    }
                });
            }

            // Gestion de la soumission du formulaire
            form.addEventListener('submit', function(e) {
                // Ne pas emp√™cher la soumission par d√©faut
                // Le formulaire doit se soumettre √† Symfony

                // D√©sactiver le bouton pour √©viter les doubles soumissions
                submitBtn.disabled = true;
                submitBtn.textContent = 'Envoi en cours...';

                // Note: Symfony g√®re la validation, l'upload, et la redirection
                // Si erreurs de validation, Symfony r√©affiche le formulaire
            });

            // Validation du t√©l√©phone en temps r√©el
            const phoneInput = document.querySelector('input[type="tel"]');
            if (phoneInput) {
                phoneInput.addEventListener('blur', function() {
                    const phoneRegex = /^(?:(?:\+|00)33|0)\s*[1-9](?:[\s.-]*\d{2}){4}$/;
                    if (this.value && !phoneRegex.test(this.value)) {
                        this.style.borderColor = '#e74c3c';
                    } else {
                        this.style.borderColor = '';
                    }
                });
            }

            // Auto-hide des messages flash apr√®s 5 secondes
            const flashMessages = document.querySelectorAll('.success-message.show');
            flashMessages.forEach(function(message) {
                setTimeout(function() {
                    message.style.transition = 'opacity 0.5s';
                    message.style.opacity = '0';
                    setTimeout(() => message.remove(), 500);
                }, 5000);
            });
        });
    </script>
{% endblock %}
